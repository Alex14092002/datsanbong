<!DOCTYPE html>
<html>
  <head>
    <title>Quản trị sân cầu lông</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
  </head>
  <style>
    .booked {
      background-color: red !important;
      color: #fff;
    }
    .not-booked {
      background-color: yellow !important;
    }
    #app {
      padding: 0 20px;
    }
  </style>
  <body>
    <div id="app" class="">
      <div class="header py-4 d-flex justify-content-between"></div>

      <div class="nav nav-pills mb-3" id="pills-tab" role="tablist"></div>
      <div class="tab-content" id="pills-tabContent"></div>
    </div>
    <div
      class="modal fade"
      id="updateBookingModal"
      tabindex="-1"
      aria-labelledby="updateBookingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateBookingModalLabel">
              Cập nhật trạng thái đặt sân
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <select class="form-select" id="bookingStatusSelect">
              <option value="Đã đặt">Đã đặt</option>
              <option value="Đã hủy">Đã hủy</option>
            </select>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
            <button type="button" class="btn btn-primary" id="updateBookingBtn">
              Lưu
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script>
      function formatCurrency(amount) {
        const formatter = new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        });
        return formatter.format(amount);
      }

      const databaseURL = "https://sancaul-default-rtdb.firebaseio.com";
      const tabContainer = document.getElementById("pills-tab");
      const contentContainer = document.getElementById("pills-tabContent");

      const checkBooking = (sanTen, blockId) => {
        const phone = localStorage.getItem("signedInPhone");

        if (phone) {
          const bookingData = {
            san: sanTen,
            status: "Đang chờ duyệt",
            user: phone,
          };
          console.log(blockId);

          fetch(`${databaseURL}/blocks.json`)
            .then((response) => response.json())
            .then((blocks) => {
              console.log(blocks);

              
                fetch(`${databaseURL}/blocks/${blockId}/listbook.json`, {
                  method: "POST",
                  body: JSON.stringify(bookingData),
                  headers: {
                    "Content-Type": "application/json",
                  },
                })
                  .then((response) => response.json())
                  .then(() => {
                    alert("Đặt lịch thành công");
                    location.reload()
                  })
                  .catch((error) => {
                    alert("Đã xảy ra lỗi khi đặt lịch");
                    console.error("Lỗi khi đặt lịch:", error);
                  });
              
            })
            .catch((error) => {
              console.error("Lỗi khi tải danh sách blocks:", error);
            });
        } else {
          alert("Bạn cần đăng nhập để đặt lịch");
          window.location.href = "./user.html";
        }
      };

      function displayTableForKhu(khuId) {
        const tabPane = document.getElementById(`khu-${khuId}`);
        const table = document.createElement("table");
        table.classList.add("table", "table-bordered");
        tabPane.appendChild(table);

        // Lấy danh sách các block
        fetch(`${databaseURL}/khu/${khuId}/sân.json`)
          .then((response) => response.json())
          .then((data) => {
            // Tạo thead với các cột
            const thead = document.createElement("thead");
            const theadRow = document.createElement("tr");
            const timeHeader = document.createElement("th");
            timeHeader.scope = "col";
            timeHeader.textContent = "Thời gian";
            theadRow.appendChild(timeHeader);

            for (const sanId in data) {
              const san = data[sanId];
              const blockHeader = document.createElement("th");
              blockHeader.scope = "col";
              blockHeader.textContent = san.ten;
              theadRow.appendChild(blockHeader);
            }
            thead.appendChild(theadRow);
            table.appendChild(thead);

            // Lấy danh sách các sân cho khu
            fetch(`${databaseURL}/blocks.json`)
              .then((response) => response.json())
              .then((blocks) => {
                // Tạo tbody với các hàng
                const tbody = document.createElement("tbody");
                for (const blockId in blocks) {
                  const block = blocks[blockId];
                  const sanRow = document.createElement("tr");
                  const sanNameCell = document.createElement("td");
                  sanNameCell.textContent =
                    block.time + "-" + formatCurrency(block.price);
                  sanRow.appendChild(sanNameCell);

                  for (const sanId in data) {
                    const blockCell = document.createElement("td");
                    blockCell.setAttribute("data-khuid", khuId);
                        blockCell.setAttribute("data-sanid", sanId);
                        blockCell.setAttribute("data-blockid", blockId);
                    sanRow.appendChild(blockCell);

                    const san = data[sanId];
                    if (block.listbook) {
                      const listbookArray = Array.isArray(block.listbook)
                        ? block.listbook
                        : Object.values(block.listbook);

                      const bookedSan = listbookArray.find(
                        (booked) => booked.san === san.ten
                      );

                      if (bookedSan) {
                        blockCell.textContent =
                          bookedSan.status + " - " + bookedSan.user;
                        blockCell.classList.add("booked");
                        blockCell.setAttribute("data-khuid", khuId);
                        blockCell.setAttribute("data-sanid", sanId);
                        blockCell.setAttribute("data-blockid", blockId);

                        if (bookedSan.hasOwnProperty("bookingId")) {
                          blockCell.setAttribute(
                            "data-bookingid",
                            bookedSan.bookingId
                          );
                        } else {
                          const listbookIndex = Object.keys(listbookArray).find(
                            (index) => listbookArray[index].san === san.ten
                          );
                          if (listbookIndex !== undefined) {
                            blockCell.setAttribute(
                              "data-bookingid",
                              listbookIndex
                            );
                          }
                        }
                      } else {
                        const button = document.createElement("button");
                        button.textContent = "Đặt lịch";
                        
                        button.classList.add(
                          "btn",
                          "btn-sm",
                          "btn-primary",
                          "m-2"
                        );

                        blockCell.appendChild(button);
                        blockCell.classList.add("not-booked");
                        
                        button.addEventListener("click", () => {
                          checkBooking(san.ten , blockId); // Truyền tên sân cho hàm checkBooking
                        });
                      }
                    } else {
                      const button = document.createElement("button");
                      button.textContent = "Đặt lịch";
                      button.classList.add(
                        "btn",
                        "btn-sm",
                        "btn-primary",
                        "m-2"
                      );
                      button.addEventListener("click", () => {
                        checkBooking(san.ten, blockId); // Truyền tên sân cho hàm checkBooking
                      });
                      blockCell.appendChild(button);
                      blockCell.classList.add("not-booked");
                    }
                  }

                  tbody.appendChild(sanRow);
                }
                table.appendChild(tbody);
              })
              .catch((error) => {
                console.error("Lỗi khi tải danh sách sân:", error);
              });
          })
          .catch((error) => {
            console.error("Lỗi khi tải danh sách block:", error);
          });
      }

      fetch(`${databaseURL}/khu.json`)
        .then((response) => response.json())
        .then((data) => {
          let firstKhuId = null;

          for (const khuId in data) {
            const khu = data[khuId];

            if (!firstKhuId) {
              firstKhuId = khuId;
            }

            const tabLink = document.createElement("button");
            tabLink.classList.add("nav-link");
            tabLink.textContent = khu.ten;
            tabLink.setAttribute("data-bs-toggle", "pill");
            tabLink.setAttribute("data-bs-target", `#khu-${khuId}`);
            tabLink.setAttribute("role", "tab");
            tabLink.setAttribute("aria-controls", `khu-${khuId}`);
            tabLink.setAttribute("aria-selected", "false");
            tabContainer.appendChild(tabLink);

            const tabPane = document.createElement("div");
            tabPane.classList.add("tab-pane", "fade");
            tabPane.id = `khu-${khuId}`;
            tabPane.setAttribute("role", "tabpanel");
            tabPane.setAttribute("aria-labelledby", `khu-${khuId}-tab`);
            contentContainer.appendChild(tabPane);

            displayTableForKhu(khuId);
          }

          const firstTabLink = document.querySelector(
            `[data-bs-target="#khu-${firstKhuId}"]`
          );
          const firstTabPane = document.getElementById(`khu-${firstKhuId}`);

          if (firstTabLink && firstTabPane) {
            firstTabLink.classList.add("active");
            firstTabPane.classList.add("show", "active");
          }
        })
        .catch((error) => {
          console.error("Lỗi khi tải danh sách khu:", error);
        });
        
    </script>
 
    <script src="./js/header.js"></script>
  </body>
</html>
